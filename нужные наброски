void game_loop(void) {
    // Инициализация ncurses
    start_to_work();
    
    // Инициализация базы предметов
    init_default_items(&global_itemdb);
    
    // Создание инвентаря
    inventory *inv = create_inventory();
    if (!inv) {
        endwin();
        fprintf(stderr, "Ошибка создания инвентаря\n");
        return;
    }
    
    // Назначаем окно для инвентаря из вашего интерфейса
    inventory_win = make_new_win(1, COLS*2/3+2, LINES-2, COLS/3-3, "Инвентарь");
    inv->win = inventory_win->overlay; // Используем overlay как рабочее окно
    
    // Создаем окно повествования
    narrative_win = make_new_win(1, 1, LINES-2, COLS*2/3, "==Dungeon==");
    
    // Инициализация состояния
    game_state state = {
        .current_mode = MODE_NARRATIVE,
        .previous_mode = MODE_NARRATIVE,
        .inventory_selected_index = 0,
        .quit_flag = 0
    };
    
    // Добавляем тестовые предметы через ВАШУ функцию
    inventory_add_item_by_id(inv, &global_itemdb, 1, 1);  // Меч
    inventory_add_item_by_id(inv, &global_itemdb, 2, 1);  // Броня
    inventory_add_item_by_id(inv, &global_itemdb, 3, 5);  // Аптечки
    
    // Экипируем меч для примера
    inventory_node *sword_node = inventory_get_node_at_index(inv, 0);
    if (sword_node) {
        inventory_equip_artifact(inv, sword_node, SLOT_WEAPON);
    }
    
    // Главный игровой цикл
    while (!state.quit_flag) {
        // Отрисовка в зависимости от режима
        switch (state.current_mode) {
            case MODE_NARRATIVE:
                // Скрываем инвентарь, показываем повествование
                if (inventory_win && inventory_win->panel) {
                    hide_panel(inventory_win->panel);
                }
                if (narrative_win && narrative_win->panel) {
                    show_panel(narrative_win->panel);
                    top_panel(narrative_win->panel);
                }
                
                // Отрисовка повествования (ваш код)
                werase(narrative_win->overlay);
                mvwprintw(narrative_win->overlay, 1, 1, "Вы в подземелье...");
                mvwprintw(narrative_win->overlay, 3, 1, "Нажмите 'i' для инвентаря");
                mvwprintw(narrative_win->overlay, 4, 1, "Нажмите 'q' для выхода");
                wrefresh(narrative_win->overlay);
                break;
                
            case MODE_INVENTORY:
                // Показываем инвентарь поверх
                if (inventory_win && inventory_win->panel) {
                    show_panel(inventory_win->panel);
                    top_panel(inventory_win->panel);
                }
                
                // Используем ВАШУ функцию display_inventory из inventory.c
                display_inventory(inv, &global_itemdb, state.inventory_selected_index);
                
                // Подсказки в инвентаре
                mvwprintw(inventory_win->overlay, getmaxy(inventory_win->overlay)-2, 2, 
                         "Стрелки: выбор  E: надеть/использовать  ESC: назад");
                wrefresh(inventory_win->overlay);
                break;
        }
        
        update_panels();
        doupdate();
        
        // Обработка ввода
        int ch = getch();
        
        switch (state.current_mode) {
            case MODE_NARRATIVE:
                switch (ch) {
                    case 'i':
                    case 'I':
                        state.previous_mode = MODE_NARRATIVE;
                        state.current_mode = MODE_INVENTORY;
                        state.inventory_selected_index = 0;
                        break;
                    case 'q':
                    case 'Q':
                        state.quit_flag = 1;
                        break;
                }
                break;
                
            case MODE_INVENTORY:
                switch (ch) {
                    case KEY_UP:
                        if (state.inventory_selected_index > 0) {
                            state.inventory_selected_index--;
                        }
                        break;
                    case KEY_DOWN:
                        if (state.inventory_selected_index < inv->count - 1) {
                            state.inventory_selected_index++;
                        }
                        break;
                    case 'e':
                    case 'E':
                        // Использовать/надеть предмет
                        inventory_node *node = inventory_get_node_at_index(inv, state.inventory_selected_index);
                        if (node && node->type == ITEM_ARTIFACT) {
                            // Простой пример: экипируем в первый доступный слот
                            for (int i = 0; i < MAX_EQUIPPED; i++) {
                                if (!inv->equipped[i]) {
                                    inventory_equip_artifact(inv, node, i);
                                    break;
                                }
                            }
                        }
                        break;
                    case 'u':
                    case 'U':
                        inventory_node *node = inventory_get_node_at_index(inv, state.inventory_selected_index);
                        if (node && node->type == ITEM_ARTIFACT) {
                            if (node->state.artifact_state.is_equipped){
                                for (int i = 0; i < MAX_EQUIPPED; i++){
                                    if (inv->equipped[i] == node) {
                                        inventory_unequip_artifact(inv, i);
                                        break;
                                    }
                                }
                            }
                        }
                        break;
                    case 27: // ESC
                        state.current_mode = state.previous_mode;
                        break;
                }
                break;
        }
    }
    
    // Очистка
    free_inventory(inv);
    
    // Удаление окон через panels (важно делать в правильном порядке)
    if (inventory_win) {
        del_panel(inventory_win->panel);
        delwin(inventory_win->overlay);
        delwin(inventory_win->decoration);
        delwin(inventory_win->background);
        free(inventory_win);
    }
    if (narrative_win) {
        del_panel(narrative_win->panel);
        delwin(narrative_win->overlay);
        delwin(narrative_win->decoration);
        delwin(narrative_win->background);
        free(narrative_win);
    }
    
    endwin();
}